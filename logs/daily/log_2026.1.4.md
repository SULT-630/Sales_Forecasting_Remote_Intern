# Daily Log — 2025-12-24

## Objective
- Run the model on the new task
- use feature importance to select feature

## Works done
- 模型代码已更改以适配新任务

## Key Findings
- 在数据集里面，相同week, sku_id, store_id就能完整表示一个相同状态
- 在原始数据集（加了log变换）：
    - overall MAPE [test, train]：10.4554, 11.1105
    - 不存在过拟合现象，虽然粗糙，但是可以作为基线模型
    - 特征重要性：
        0           sku_id   22.884476
        1  is_discount_sku   17.826218
        2   is_display_sku   16.908337
        3  is_featured_sku   10.165929
        4         store_id    8.548273
        5      total_price    2.491251
        6   discount_ratio    2.274858
        7       base_price    1.753311

- 在做了特征工程之后：
    - overall MAPE [test, train]：10.9545, 7.7353
    - 最大MAPE：25.2495 at sku_id = 545621
    - 明显过拟合，因为增加了过多冗余特征
    - 特征重要性：
        0            rolling_mean_4_records   91.795082
        1                   is_featured_sku   73.247963
        2                    is_display_sku   62.642269
        3                    ewma_4_records   60.329418
        4                   is_discount_sku   38.938480
        5                    discount_ratio   10.001703
        6                            sku_id    5.343730
        7                       total_price    4.302957
        8                    ewma_3_records    3.366103
        9                          store_id    2.906142
        10                       base_price    2.604868
        11                        cos_month    2.332377
        12                          quarter    2.076344
        13          gap_since_lag_2_records    2.016497
        14          gap_since_lag_4_records    2.002003
        15          gap_since_lag_1_records    1.926844
        16                        sin_month    1.890433
        17                 cos_week_of_year    1.879181
        18                 sin_week_of_year    1.751856
        19            rolling_std_4_records    1.691020
        20  target_changing_rate_per_week_4    1.631941
        21                      lag_4_weeks    1.530615
        22            rolling_std_3_records    1.147688
        23                      lag_2_weeks    1.053680
        24                      lag_1_weeks    1.029085
        25           rolling_mean_2_records    1.024756
        26                   ewma_2_records    1.019284
        27           rolling_mean_3_records    1.009861
        28  target_changing_rate_per_week_2    0.998436
        29  target_changing_rate_per_week_1    0.951324
        30            rolling_std_2_records    0.802196

- 对比试验：比较rolling与ewm，without rolling
    - overall MAPE [test, train]：10.8926,7.8675
    - 最大MAPE：25.1246 at sku_id = 545621
    - 特征重要性：
        0                    ewma_4_records   85.210960
        1                   is_featured_sku   70.592255
        2                    is_display_sku   58.944157
        3                    ewma_3_records   23.660398
        4                   is_discount_sku   18.012863
        5                    discount_ratio   11.663728
        6                    ewma_2_records    6.014085
        7                            sku_id    5.900982
        8                       total_price    4.162657
        9                       lag_4_weeks    3.755399
        10                         store_id    2.968635
        11                        cos_month    2.161716
        12                       base_price    1.961257
        13          gap_since_lag_4_records    1.929922
        14          gap_since_lag_2_records    1.900595
        15                 cos_week_of_year    1.805526
        16                          quarter    1.796619
        17                        sin_month    1.787806
        18          gap_since_lag_1_records    1.765466
        19                 sin_week_of_year    1.643434
        20  target_changing_rate_per_week_4    1.440622
        21  target_changing_rate_per_week_2    1.427525
        22                      lag_2_weeks    1.248744
        23                      lag_1_weeks    1.188312
        24  target_changing_rate_per_week_1    0.891081

- 对比试验：比较rolling与ewm，without ewm
    - overall MAPE [test, train]：10.9206, 7.7828
    - 最大MAPE：23.469831 at sku_id = 545621
    - 不如without rolling，所以选择前者
    - 特征重要性：

- 对比试验：best去除了target changing rate per week 1
    - overall MAPE [test, train]：10.9941, 7.9742
    - 最大MAPE：23.0591 at sku_id = 300291
    - 过拟合现象类似，但是总MAPE上升，应该保留
    - 特征重要性：

- 对比试验：best去除lag1
    - overall MAPE [test, train]：10.8430，7.9368
    - 最大MAPE：23.209527 at sku_id = 245387
    - 过拟合现象缓解，MAPE下降，应该去除
    - 特征重要性：
        0                    ewma_4_records   76.071243
        1                   is_featured_sku   64.307121
        2                    is_display_sku   52.684452
        3                   is_discount_sku   35.249817
        4                    ewma_3_records   30.991488
        5                    discount_ratio   10.146448
        6                            sku_id    5.208995
        7                       total_price    4.384733
        8                       lag_4_weeks    3.621084
        9                          store_id    2.731445
        10                       base_price    2.388528
        11                        cos_month    2.381365
        12                          quarter    1.940220
        13          gap_since_lag_1_records    1.900772
        14          gap_since_lag_4_records    1.883819
        15          gap_since_lag_2_records    1.869642
        16                 cos_week_of_year    1.782885
        17                        sin_month    1.697189
        18                 sin_week_of_year    1.681859
        19  target_changing_rate_per_week_4    1.498498
        20  target_changing_rate_per_week_2    1.370207
        21                      lag_2_weeks    1.242267
        22                   ewma_2_records    1.066347
        23  target_changing_rate_per_week_1    0.929151

- 对比试验：best去除ewm2
    - overall MAPE [test, train]：11.0297，7.9523
    - 最大MAPE：22.892783 at sku_id = 245387
    - MAPE上升，应该保留
    - 特征重要性：

- 对比试验：best去除lag2
    - overall MAPE [test, train]：10.6381，7.9753
    - 最大MAPE：23.280735 at sku_id = 245387
    - 过拟合现象缓解，总MAPE下降，应该去除
    - 特征重要性：
        0                    ewma_4_records   77.685196
        1                   is_featured_sku   68.919228
        2                   is_discount_sku   52.994373
        3                    is_display_sku   46.731956
        4                    ewma_3_records   13.510029
        5                    discount_ratio    7.469445
        6                            sku_id    5.065616
        7                       total_price    4.426603
        8                          store_id    3.018454
        9                       lag_4_weeks    2.728717
        10                        cos_month    2.224116
        11                       base_price    2.194016
        12                        sin_month    1.880038
        13          gap_since_lag_4_records    1.791115
        14          gap_since_lag_2_records    1.782087
        15                 cos_week_of_year    1.781701
        16          gap_since_lag_1_records    1.761135
        17                          quarter    1.684452
        18                 sin_week_of_year    1.580101
        19  target_changing_rate_per_week_4    1.379158
        20  target_changing_rate_per_week_2    1.359888
        21                   ewma_2_records    1.017617
        22  target_changing_rate_per_week_1    0.922810

- 对比试验：best去除target changing rate per week2
    - overall MAPE [test, train]：10.8004, 8.0416
    - 最大MAPE：22.350264 at sku_id = 245387
    - 应该保留
    - 特征重要性：
- 对比试验：best去除target changing rate per week4
    - overall MAPE [test, train]：10.6687，8.0268
    - 最大MAPE：22.116523 at sku_id = 245387
    - 总MAPE略微上升，但过拟合现象缓解，且最大MAPE下降说明更稳定？应该去除
    - 特征重要性：
        0                   is_featured_sku   62.484890
        1                    ewma_4_records   51.668499
        2                    is_display_sku   41.064106
        3                   is_discount_sku   38.789444
        4                    ewma_3_records   25.718937
        5                    discount_ratio    8.940071
        6                            sku_id    5.528094
        7                    ewma_2_records    4.896941
        8                       lag_4_weeks    4.037866
        9                       total_price    3.739764
        10                         store_id    3.070289
        11                        cos_month    2.069756
        12                       base_price    1.937202
        13          gap_since_lag_1_records    1.901729
        14          gap_since_lag_4_records    1.792800
        15                 cos_week_of_year    1.739635
        16                        sin_month    1.710724
        17          gap_since_lag_2_records    1.674482
        18                          quarter    1.618900
        19                 sin_week_of_year    1.514216
        20  target_changing_rate_per_week_2    1.450240
        21  target_changing_rate_per_week_1    0.921964

- 对比试验：best去除sin/cos_week_of_year
    - overall MAPE [test, train]：10.7196, 8.0476
    - 最大MAPE：23.715992 at sku_id = 245387
    - 应该保留
    - 特征重要性：

- 对比试验：best去除quarter
    - overall MAPE [test, train]：10.8049, 8.0131
    - 最大MAPE：24.284440 at sku_id = 545621
    - 应该保留
    - 特征重要性：

- 对比试验：best去除gap since lag 2
    - overall MAPE [test, train]：10.5795, 8.0860
    - 最大MAPE：26.251115 at sku_id = 545621
    - 应该去除
    - 特征重要性：
        0                   is_featured_sku   62.500576
        1                    ewma_4_records   62.312531
        2                   is_discount_sku   50.196350
        3                    is_display_sku   41.526901
        4                    ewma_3_records   13.011862
        5                    discount_ratio    8.001332
        6                    ewma_2_records    5.960502
        7                            sku_id    5.459793
        8                       total_price    3.862391
        9                       lag_4_weeks    3.229175
        10                         store_id    2.889206
        11                       base_price    2.185966
        12                        cos_month    2.130338
        13                          quarter    1.871322
        14                        sin_month    1.841120
        15          gap_since_lag_4_records    1.769104
        16          gap_since_lag_1_records    1.747790
        17                 cos_week_of_year    1.682231
        18                 sin_week_of_year    1.605461
        19  target_changing_rate_per_week_2    1.514189
        20  target_changing_rate_per_week_1    0.938982

- 对比试验：best去除gap since lag 1
    - overall MAPE [test, train]：10.7750，8.1289
    - 最大MAPE：23.583768 at sku_id = 545621
    - 应该保留
    - 特征重要性：

- 对比试验：best去除gap since lag 4
    - overall MAPE [test, train]：10.3074, 8.2578
    - 最大MAPE：25.351094 at sku_id = 545621
    - 应该去除
    - 特征重要性：
        0                    ewma_4_records   67.196899
        1                   is_featured_sku   59.165054
        2                    is_display_sku   44.065285
        3                   is_discount_sku   32.455341
        4                    ewma_3_records   12.955229
        5                    discount_ratio    7.893333
        6                            sku_id    5.235208
        7                       total_price    3.515023
        8                          store_id    2.959133
        9                       lag_4_weeks    2.522928
        10                        cos_month    2.141491
        11                       base_price    2.130302
        12          gap_since_lag_1_records    1.751656
        13                        sin_month    1.629558
        14                 cos_week_of_year    1.591467
        15                          quarter    1.431172
        16                 sin_week_of_year    1.422082
        17  target_changing_rate_per_week_2    1.313548
        18                   ewma_2_records    1.067014
        19  target_changing_rate_per_week_1    0.913191

- 对比试验：best去除sin/cos month
    - overall MAPE [test, train]：10.4175, 8.3489
    - 最大MAPE： at sku_id = 
    - 应该保留
    - 特征重要性：

- 对比试验：best去除lag4
    - overall MAPE [test, train]：10.4669, 8.4335
    - 最大MAPE： at sku_id = 
    - 应该保留
    - 特征重要性：

- 对比试验：best去除discount ratio
    - overall MAPE [test, train]：10.2404, 8.3030
    - 最大MAPE： at sku_id = 
    - 应该去除
    - 特征重要性：
        0                    ewma_4_records   64.902687
        1                   is_featured_sku   57.962467
        2                   is_discount_sku   44.012779
        3                    is_display_sku   33.090714
        4                    ewma_3_records    8.406177
        5                            sku_id    5.840263
        6                       total_price    4.037717
        7                    ewma_2_records    3.708868
        8                          store_id    3.032675
        9                       lag_4_weeks    2.714940
        10                       base_price    2.221967
        11                        cos_month    2.094369
        12                 cos_week_of_year    1.687562
        13          gap_since_lag_1_records    1.673806
        14                        sin_month    1.648008
        15                 sin_week_of_year    1.527734
        16                          quarter    1.356088
        17  target_changing_rate_per_week_2    1.350699
        18  target_changing_rate_per_week_1    0.935309

- 对比试验：best去除sin week of year
    - overall MAPE [test, train]：10.3683, 8.3165
    - 最大MAPE： at sku_id = 
    - 应该保留
    - 特征重要性：

- 对比试验：best去除sin month
    - overall MAPE [test, train]：10.2442, 8.3084
    - 最大MAPE： at sku_id = 
    - 应该保留
    - 特征重要性：

- 对比试验：best去除ewm2
    - overall MAPE [test, train]：10.1741, 8.3629
    - 最大MAPE： at sku_id = 
    - 应该去除
    - 特征重要性：
        0                   is_featured_sku   55.091522
        1                    ewma_4_records   54.141895
        2                    is_display_sku   37.883442
        3                   is_discount_sku   30.369694
        4                    ewma_3_records    9.491354
        5                            sku_id    5.739159
        6                       total_price    3.812268
        7                          store_id    3.001217
        8                       lag_4_weeks    2.582089
        9                         cos_month    2.293990
        10                       base_price    1.796246
        11                        sin_month    1.759938
        12          gap_since_lag_1_records    1.731536
        13                 cos_week_of_year    1.687884
        14                 sin_week_of_year    1.498850
        15  target_changing_rate_per_week_2    1.344144
        16                          quarter    1.289878
        17  target_changing_rate_per_week_1    0.927613

- 对比试验：best去除ewm3
    - overall MAPE [test, train]：10.0556，8.3980
    - 最大MAPE： at sku_id = 
    - 应该去除
    - 特征重要性：
        0                   is_featured_sku   46.189259
        1                    is_display_sku   41.696892
        2                   is_discount_sku   33.179703
        3                    ewma_4_records   32.361427
        4                            sku_id    7.182066
        5                       lag_4_weeks    6.528814
        6                          store_id    3.904730
        7                       total_price    3.463405
        8                        base_price    2.564875
        9                         cos_month    2.138999
        10                        sin_month    1.736367
        11          gap_since_lag_1_records    1.639393
        12                 cos_week_of_year    1.551599
        13                 sin_week_of_year    1.375410
        14                          quarter    1.302086
        15  target_changing_rate_per_week_2    1.186457
        16  target_changing_rate_per_week_1    0.914494

- 对比试验：best去除ewm4
    - overall MAPE [test, train]：10.0977，8.5147
    - 最大MAPE： at sku_id = 
    - 缓解了过拟合但是总MAPE上升了。应该去除？
    - 特征重要性：

- 对比试验：best去除is_discount_sku
    - overall MAPE [test, train]：10.1425, 8.5478
    - 最大MAPE： at sku_id = 
    - 应该保留
    - 特征重要性：

- 对比试验：best用ewm8换ewm4
    - overall MAPE [test, train]：10.2657，8.3895
    - 最大MAPE： at sku_id = 
    - ewm8不好
    - 特征重要性：

- 对比试验：best有ewm用lag8换lag4
    - overall MAPE [test, train]：10.3358，8.3751
    - 最大MAPE： at sku_id = 
    - lag8不好
    - 特征重要性：

- 对比试验：best无ewm用lag8换lag4
    - overall MAPE [test, train]：10.2201，8.5054
    - 最大MAPE： at sku_id = 
    - lag8不好
    - 特征重要性：

- best after fill na
    - overall MAPE [test, train]：10.1406, 8.4692
    - 最大MAPE： at sku_id = 
    - 特征重要性：
        0                    is_display_sku   44.262962
        1                   is_featured_sku   43.334667
        2                   is_discount_sku   33.546059
        3                    ewma_4_records   31.847324
        4                            sku_id    7.466037
        5                       lag_4_weeks    7.072981
        6                          store_id    3.981938
        7                       total_price    3.322226
        8                        base_price    2.531053
        9                         cos_month    2.199810
        10          gap_since_lag_1_records    1.929126
        11                        sin_month    1.659615
        12                 cos_week_of_year    1.553964
        13                 sin_week_of_year    1.394215
        14                          quarter    1.291888
        15  target_changing_rate_per_week_2    1.172704
        16  target_changing_rate_per_week_1    0.918710

- 对比试验：best去除ewm4
    - overall MAPE [test, train]：10.1924, 8.5670
    - 最大MAPE： at sku_id = 
    - 缓解了过拟合但是总MAPE上升了。应该去除？
    - 特征重要性：
        ...
- 对比试验：best去除target changing rate per lag2
    - overall MAPE [test, train]：10.0241, 8.8596
    - 最大MAPE： at sku_id = 
    - 应该去除
    - 特征重要性：
        0                    is_display_sku   39.011448
        1                   is_discount_sku   30.213554
        2                   is_featured_sku   24.269302
        3                       lag_4_weeks   19.980705
        4                            sku_id   12.177522
        5                          store_id    5.392425
        6                       total_price    3.928869
        7                        base_price    2.212324
        8                         cos_month    1.783338
        9                  cos_week_of_year    1.476148
        10                        sin_month    1.449256
        11          gap_since_lag_1_records    1.425787
        12                 sin_week_of_year    1.271026
        13                          quarter    1.216996
        14  target_changing_rate_per_week_1    0.822181

- 对比试验：best加上ewm24
    - overall MAPE [test, train]：9.9681， 8.6179
    - 最大MAPE： at sku_id = 
    - accept
    - 特征重要性：
        0                   is_featured_sku   64.139305
        1                   ewma_24_records   37.661308
        2                   is_discount_sku   24.843378
        3                    is_display_sku   21.803610
        4                            sku_id    4.338342
        5                       lag_4_weeks    4.162189
        6                       total_price    2.843747
        7                          store_id    2.580018
        8                         cos_month    2.020785
        9           gap_since_lag_1_records    1.938830
        10                       base_price    1.694779
        11                 cos_week_of_year    1.397309
        12                        sin_month    1.353123
        13                 sin_week_of_year    1.213130
        14                          quarter    1.202429
        15  target_changing_rate_per_week_1    0.774858
    
- 对比试验：best加上lag is display/featured
    - overall MAPE [test, train]：9.9507, 8.5421
    - 最大MAPE： at sku_id = 
    - accept
    - 特征重要性：

- best 加上price change ratio lag1 base + total
    - overall MAPE [test, train]：9.93，8.41 (如果只有base： 9.93， 8.52，如果只有total： 9.7575， 8.4679)
    - 最大MAPE： at sku_id = 
    - 特征重要性：
        0                   is_featured_sku   71.531555
        1                   ewma_24_records   38.222282
        2                    is_display_sku   33.847782
        3                   is_discount_sku   29.992920
        4                       lag_4_weeks    6.316017
        5                            sku_id    6.106722
        6                          store_id    3.399276
        7          total_price_change_ratio    2.401396
        8                       total_price    2.361559
        9                        base_price    2.261280
        10          gap_since_lag_1_records    1.993161
        11                        cos_month    1.921637
        12                 cos_week_of_year    1.420338
        13                        sin_month    1.325821
        14                 sin_week_of_year    1.279370
        15                          quarter    1.202141
        16  target_changing_rate_per_week_1    0.816668

- 在一个维度上其他全部聚合的特征，会显著导致过拟合的产生，因此放弃

- 同一个week，store上的聚合特征
    - overall MAPE： 10.0485， 8.4076

- 超参数调优：
    - best iteration = 629

- 应用early stopping，valid set是训练集最后两周
    - overall MAPE [test, train, valid]： 9.9792, 8.9289, 10.6461
    - 泛化更好，但是精度略差
    - 你的 valid 是：Valid MAPE = 10.6461，明显比 test ，train 高这说明模型在 valid 这两周里更难预测，而 early stopping 是在“保守地”对这段数据负责。换句话说：early stopping 选择的是“对近期数据不那么激进的模型” 而之前的best：更贴合历史 但对“最近变化”更冒险

- max depth = 
## Issues Encountered
- Data leakage also appear even if I only select the last week
## How Issues Were Resolved
- checking only one line of data for same week, sku_id, store_id, then apply sort_values with the three and group_by with sku_id and store_id
## Problems
- 为什么要去除lag1，2但是要保留lag4
- 为什么保留gap since lag 1,2 但是去除4
- 为什么应该去除ewm，和直觉不符，去除ewm2，ewm3时候，预测精度更好，过拟合也缓解，但是去除ewm4时候，精度下降，但过拟合也缓解（去除4时，就没有ewm特征了）
- 有没有什么好的fill na method
- 由于日期并非真实，手动标注节假日不太可行，有没有其他的可以代替节假日效应的因子
## Next Steps
2025.9.12 - 2031.10.11